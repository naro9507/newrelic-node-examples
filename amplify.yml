version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 18
        - nvm use 18
        - npm install
    build:
      commands:
        - env | grep -e NEW_RELIC_ >> .env.production
        - env | grep -e NODE_OPTIONS >> .env.production

        - npm run build
        - rm -rf .amplify-hosting
        - mkdir -p .amplify-hosting/compute/default
        - mkdir -p .amplify-hosting/static
        - cp -r .next/standalone/* .amplify-hosting/compute/default/
        - if [ -d public ]; then cp -r public .amplify-hosting/compute/default/public; fi
        - cp -r .next/static/* .amplify-hosting/static/
        - |
          cat > .amplify-hosting/deploy-manifest.json << 'JSON'
          {
            "version": 1,
            "framework": { "name": "custom-server", "version": "1.0.0" },
            "routes": [
              { "path": "/*.*", "target": { "kind": "Static" }, "fallback": { "kind": "Compute", "src": "default" } },
              { "path": "/*",   "target": { "kind": "Compute", "src": "default" } }
            ],
            "computeResources": [
              { "name": "default", "runtime": "nodejs18.x", "entrypoint": "server.js" }
            ]
          }
          JSON
  artifacts:
    baseDirectory: .amplify-hosting
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
