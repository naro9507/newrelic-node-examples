version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - nvm install 18
            - nvm use 18
            - npm ci
        build:
          commands:
            - |
              set -euo pipefail
              # 環境変数を必要なら吐き出す
              env | grep -e NEW_RELIC_ >> .env.production || true
              env | grep -e NODE_OPTIONS >> .env.production || true
              # Next を build（standalone 必須）
              npm run build
              # アーティファクトを組み立て
              rm -rf .amplify-hosting
              mkdir -p .amplify-hosting/compute/default .amplify-hosting/static/_next/static
              cp -r .next/standalone/* .amplify-hosting/compute/default/
              [ -d public ] && cp -r public .amplify-hosting/compute/default/public
              [ -d .next/static ] && cp -r .next/static/* .amplify-hosting/static/_next/static/
              cp deploy-manifest.json .amplify-hosting/
      artifacts:
        baseDirectory: .amplify-hosting
        files:
          - "**/*"
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
