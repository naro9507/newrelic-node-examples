version: 1
applications:
  - appRoot: deploy
    frontend:
      phases:
        preBuild:
          commands:
            - nvm install 18 && nvm use 18
            - npm ci --prefix ..
        build:
          commands:
            - |
              set -e
              cd ..
              npm run build
              rm -rf .amplify-hosting
              mkdir -p .amplify-hosting/compute/default .amplify-hosting/static/_next/static
              cp -r .next/standalone/* .amplify-hosting/compute/default/
              [ -d public ] && cp -r public .amplify-hosting/compute/default/public
              [ -d .next/static ] && cp -r .next/static/* .amplify-hosting/static/_next/static/
              cp deploy-manifest.json .amplify-hosting/
      artifacts:
        baseDirectory: ../.amplify-hosting
        files: ["**/*"]
      cache:
        paths:
          - ../node_modules/**/*
          - ../.next/cache/**/*
